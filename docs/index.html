<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk-Based Guardrail Withdrawal Calculator | Kitce's Monte Carlo Method</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ðŸŽ¯ Risk-Based Guardrail Withdrawal Calculator</h1>
            <p class="subtitle">Monte Carlo Probability of Success Analysis</p>
            <p class="description">
                Based on the <a href="https://www.kitces.com/blog/risk-based-monte-carlo-probability-of-success-guardrails-retirement-distribution-hatchet/" target="_blank">Risk-Based Guardrails</a> methodology
            </p>
        </header>

        <div class="main-content">
            <div class="two-column-layout" id="twoColumnLayout">
                <!-- Left Column: Inputs -->
                <aside class="column-left" id="inputColumn">
                    <div class="column-left-content">
                        <!-- Calculator Form -->
                        <div class="card calculator-card">
                            <div class="input-header">
                                <h2>ðŸ“Š Input Parameters</h2>
                                <button type="button" class="collapse-toggle" id="collapseBtn" aria-label="Collapse input panel" title="Collapse inputs">
                                    <span class="collapse-icon" id="collapseIcon">â—€</span>
                                </button>
                            </div>

                            <div class="input-body">
                
                <form id="calculatorForm">
                    <!-- Personal Information -->
                    <fieldset>
                        <legend>Personal Information</legend>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="spouse1Age">Your Age (or Spouse 1)</label>
                                <input type="number" id="spouse1Age" name="spouse1_age" required min="18" max="120" value="67">
                            </div>
                            <div class="form-group">
                                <label for="spouse2Age">Spouse 2 Age (optional)</label>
                                <input type="number" id="spouse2Age" name="spouse2_age" min="18" max="120" placeholder="Leave blank if single">
                                <small>Leave empty for single-person planning</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="retirementAge">Age at Retirement</label>
                                <input type="number" id="retirementAge" name="retirement_age" required min="18" max="120" value="65">
                                <small>Use younger spouse's age if couple</small>
                            </div>
                            <div class="form-group">
                                <label for="planningHorizon">Planning Horizon (years)</label>
                                <input type="number" id="planningHorizon" name="planning_horizon_years" required min="1" max="60" value="30">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Portfolio Information -->
                    <fieldset>
                        <legend>Portfolio Information</legend>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="currentPortfolio">Current Portfolio Value</label>
                                <input type="number" id="currentPortfolio" name="current_portfolio_value" required min="0" step="1" value="1050000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="desiredSpending">Desired Annual Spending</label>
                                <input type="number" id="desiredSpending" name="desired_spending" required min="0" step="1" value="45000">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Asset Allocation -->
                    <fieldset>
                        <legend>Asset Allocation</legend>
                        <div class="allocation-display">
                            <div class="allocation-bar" id="allocationBar"></div>
                            <p class="allocation-total">Total: <span id="allocationTotal">100.0</span>%</p>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="stockAllocation">Stocks (%)</label>
                                <input type="number" id="stockAllocation" name="stock_allocation" required min="0" max="100" step="0.1" value="60">
                            </div>
                            <div class="form-group">
                                <label for="bondAllocation">Bonds (%)</label>
                                <input type="number" id="bondAllocation" name="bond_allocation" required min="0" max="100" step="0.1" value="35">
                            </div>
                            <div class="form-group">
                                <label for="cashAllocation">Cash (%)</label>
                                <input type="number" id="cashAllocation" name="cash_allocation" required min="0" max="100" step="0.1" value="5">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Fees and Inflation -->
                    <fieldset>
                        <legend>Fees & Inflation</legend>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="annualFee">Annual Fee (%)</label>
                                <input type="number" id="annualFee" name="annual_fee_percentage" min="0" max="5" step="0.01" value="0.04">
                                <small>Enter as percentage (e.g., 0.75 for 0.75%, not 75)</small>
                            </div>
                            <div class="form-group">
                                <label for="inflationRate">Assumed Inflation Rate (%)</label>
                                <input type="number" id="inflationRate" name="inflation_rate" min="-10" max="20" step="0.1" value="2.5">
                                <small>Enter as percentage (e.g., 2.5 for 2.5%)</small>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Income Sources -->
                    <fieldset>
                        <legend>Income Sources (Social Security, Pensions, etc.)</legend>
                        <div id="incomeSourcesContainer"></div>
                        <button type="button" class="btn btn-secondary" id="addIncomeSource">+ Add Income Source</button>
                    </fieldset>

                    <!-- Future Expenses -->
                    <fieldset>
                        <legend>Future Expenses</legend>
                        <div id="expenseItemsContainer"></div>
                        <button type="button" class="btn btn-secondary" id="addExpenseItem">+ Add Future Expense</button>
                    </fieldset>

                    <!-- Spending Profile -->
                    <fieldset>
                        <legend>Spending Profile</legend>
                        <div class="form-group">
                            <label for="spendingProfile">Spending Pattern</label>
                            <select id="spendingProfile" name="spending_profile_type">
                                <option value="smile" selected>Retirement Spending Smile (Recommended)</option>
                                <option value="flat">Flat (Constant Real Spending)</option>
                            </select>
                            <small>Spending smile reflects research showing spending naturally declines in retirement</small>
                        </div>
                    </fieldset>

                    <!-- Guardrail Settings -->
                    <fieldset>
                        <legend>Guardrail Settings</legend>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="lowerGuardrail">Lower Guardrail (% PoS)</label>
                                <input type="number" id="lowerGuardrail" name="lower_guardrail" min="50" max="95" step="0.1" value="80">
                            </div>
                            <div class="form-group">
                                <label for="upperGuardrail">Upper Guardrail (% PoS)</label>
                                <input type="number" id="upperGuardrail" name="upper_guardrail" min="55" max="99" step="0.1" value="95">
                            </div>
                            <div class="form-group">
                                <label for="targetGuardrail">Target PoS (%)</label>
                                <input type="number" id="targetGuardrail" name="target_guardrail" min="50" max="99" step="0.1" value="90">
                            </div>
                        </div>
                        <small>When guardrails are breached, spending is adjusted to return to the target PoS</small>
                    </fieldset>

                    <!-- Advanced Simulation Options -->
                    <fieldset class="advanced-fieldset">
                        <legend>
                            <button type="button" class="legend-toggle" id="advancedToggle" aria-expanded="false" aria-controls="advancedContent">
                                Advanced Simulation Options â–¸
                            </button>
                        </legend>
                        <div id="advancedContent" class="advanced-content" style="display: none;">
                            <div class="info-box">
                                <p>
                                    <strong>Why Enhanced Monte Carlo?</strong>
                                    Standard Monte Carlo assumes each year's return is independent. However, 
                                    <a href="https://www.kitces.com/blog/monte-carlo-simulation-historical-returns-sequence-risk-calculate-sustainable-spending-levels/" target="_blank">research by Kitces, Fitzpatrick & Tharp</a> 
                                    shows that this can overstate sustainable spending by 5â€“10% at typical confidence levels (70â€“90% probability of success), because 
                                    real markets exhibit mean reversion â€” prolonged downturns are historically followed by recoveries, and vice versa.
                                </p>
                                <p style="margin-top: 8px;">
                                    Enhanced mode runs a second simulation using log-normal returns with mean reversion and displays both results side-by-side for comparison.
                                </p>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="checkbox-label" for="enhancedMcEnabled">
                                        <input type="checkbox" id="enhancedMcEnabled" name="enhanced_mc_enabled" value="true">
                                        <span>Enable Enhanced Monte Carlo Comparison</span>
                                    </label>
                                    <small>Runs a second simulation with mean-reverting returns alongside the standard one</small>
                                </div>
                            </div>
                            <div id="enhancedMcOptions" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="enhancedMcAutocorrelation">Mean Reversion Strength</label>
                                        <div class="range-with-value">
                                            <input type="range" id="enhancedMcAutocorrelation" name="enhanced_mc_autocorrelation" 
                                                   min="-0.40" max="0" step="0.01" value="-0.10">
                                            <span id="autocorrelationValue" class="range-value">-0.10</span>
                                        </div>
                                        <small>
                                            Autocorrelation coefficient (Ï†). More negative = stronger mean reversion. 
                                            Default -0.10 is a conservative empirical estimate. Set to 0 for log-normal returns with no mean reversion.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                        </form>
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Right Column: Actions & Results -->
                <main class="column-right" id="resultsColumn">
                    <div class="column-right-content">
                        <div class="form-actions">
                            <button type="submit" form="calculatorForm" class="btn btn-primary" id="calculateBtn">
                                ðŸ”¬ Run Simulations (10,000 iterations)
                            </button>
                            <button type="button" class="btn btn-secondary" id="shareLinkBtn">
                                ðŸ”— Copy Shareable Link
                            </button>
                        </div>

                        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                            <div class="spinner"></div>
                            <p>Running Monte Carlo simulation...</p>
                        </div>

            <!-- Results Section -->
            <div id="resultsSection" class="card results-card" style="display: none;">
                <h2>ðŸ“ˆ Analysis Results</h2>
                
                <!-- Main Results -->
                <div class="results-summary">
                    <!-- Enhanced MC Comparison Banner (hidden by default) -->
                    <div id="enhancedComparisonBanner" class="comparison-banner" style="display: none;">
                        <h3>ðŸ“Š Standard vs. Enhanced Monte Carlo Comparison</h3>
                        <p id="comparisonSummary"></p>
                    </div>

                    <div class="result-primary">
                        <div class="pos-gauge">
                            <div class="pos-value" id="posValue">--</div>
                            <div class="pos-label">Probability of Success</div>
                        </div>
                        <div class="guardrail-indicator" id="guardrailIndicator">
                            <div class="status-badge" id="statusBadge">--</div>
                        </div>
                    </div>
                    
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">Desired Spending</div>
                            <div class="result-value" id="desiredSpendingResult">--</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Recommended Spending</div>
                            <div class="result-value" id="recommendedSpendingResult">--</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Adjustment Needed</div>
                            <div class="result-value" id="adjustmentResult">--</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Current Withdrawal Rate</div>
                            <div class="result-value" id="withdrawalRateResult">--</div>
                        </div>
                    </div>

                    <!-- Enhanced MC Results Grid (hidden by default) -->
                    <div id="enhancedResultsGrid" class="result-grid enhanced-results-grid" style="display: none;">
                        <div class="enhanced-results-header">
                            <h4 id="comparisonGridTitle">Enhanced Monte Carlo (Mean-Reverting)</h4>
                        </div>
                        <div class="result-item">
                            <div class="result-label" id="comparisonPosLabel">Enhanced PoS</div>
                            <div class="result-value" id="enhancedPosResult">--</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label" id="comparisonSpendingLabel">Enhanced Recommended Spending</div>
                            <div class="result-value" id="enhancedRecommendedResult">--</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label" id="comparisonAdjustmentLabel">Enhanced Adjustment</div>
                            <div class="result-value" id="enhancedAdjustmentResult">--</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label" id="comparisonFourthLabel">Mean Reversion (Ï†)</div>
                            <div class="result-value" id="enhancedAutocorrelationResult">--</div>
                        </div>
                    </div>
                </div>

                <!-- Interpretation -->
                <div class="interpretation-box" id="interpretationBox">
                    <h3>ðŸ’¡ Interpretation</h3>
                    <p id="interpretationText">--</p>
                </div>

                <!-- Charts -->
                <div class="charts-container">
                    <div class="chart-box">
                        <h3>Portfolio Projection (Monte Carlo)</h3>
                        <canvas id="projectionChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>Income & Expenses Over Time</h3>
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>

                <!-- Detailed Statistics -->
                <div class="stats-details">
                    <h3>ðŸ“Š Detailed Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Monte Carlo Iterations:</span>
                            <span class="stat-value" id="statIterations">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Successful Scenarios:</span>
                            <span class="stat-value" id="statSuccessful">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Failed Scenarios:</span>
                            <span class="stat-value" id="statFailed">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Median Final Portfolio:</span>
                            <span class="stat-value" id="statMedian">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">10th Percentile:</span>
                            <span class="stat-value" id="statP10">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">90th Percentile:</span>
                            <span class="stat-value" id="statP90">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Expected Return:</span>
                            <span class="stat-value" id="statExpectedReturn">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Portfolio Volatility:</span>
                            <span class="stat-value" id="statVolatility">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Current Year Income:</span>
                            <span class="stat-value" id="statYear0Income">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Current Year Expenses:</span>
                            <span class="stat-value" id="statYear0Expenses">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Current Year Withdrawal:</span>
                            <span class="stat-value" id="statYear0NetWithdrawal">--</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Calculation Time:</span>
                            <span class="stat-value" id="statDuration">--</span>
                        </div>
                    </div>

                    <!-- Enhanced MC Statistics (hidden by default) -->
                    <div id="enhancedStatsSection" style="display: none;">
                        <h4 style="margin-top: 20px; color: var(--text-heading);">Enhanced Monte Carlo Statistics</h4>
                        <div class="stats-grid" style="margin-top: 10px;">
                            <div class="stat-item">
                                <span class="stat-label">Enhanced Iterations:</span>
                                <span class="stat-value" id="statEnhancedIterations">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Enhanced Successful:</span>
                                <span class="stat-value" id="statEnhancedSuccessful">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Enhanced Failed:</span>
                                <span class="stat-value" id="statEnhancedFailed">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Enhanced Median Final:</span>
                                <span class="stat-value" id="statEnhancedMedian">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Enhanced 10th Percentile:</span>
                                <span class="stat-value" id="statEnhancedP10">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Enhanced 90th Percentile:</span>
                                <span class="stat-value" id="statEnhancedP90">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Enhanced Calc Time:</span>
                                <span class="stat-value" id="statEnhancedDuration">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <footer class="footer">
                    <p>
                        <strong>Disclaimer:</strong> This calculator is for educational and planning purposes only. 
                        It does not constitute financial advice. Monte Carlo simulations are based on historical 
                        return assumptions and may not predict actual future performance. 
                        Consult with a qualified financial advisor before making investment decisions.
                    </p>
                    <p class="footer-links">
                        <a href="https://www.kitces.com/blog/risk-based-monte-carlo-probability-of-success-guardrails-retirement-distribution-hatchet/" target="_blank">Learn More About Risk-Based Guardrails</a>
                    </p>
                </footer>
            </div>
                    </div>
                </main>
            </div>
        </div>

    </div>

    <script src="js/app.js"></script>
    <script src="js/calculator-form.js"></script>
    <script src="js/charts.js"></script>
</body>
</html>
